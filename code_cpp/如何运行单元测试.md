# 如何运行单元测试 - 完整指南

## 前提条件检查

### 1. 检查 GTest 是否已安装

```bash
cd ~/软工/code_cpp

# 运行检查脚本
chmod +x 测试GTest安装.sh
./测试GTest安装.sh
```

如果显示 ❌ 未找到，需要先安装 GTest。

---

## 步骤1: 安装 GTest（如果未安装）

### 方法A: 使用包管理器（推荐）

```bash
# 安装 GTest 开发包
sudo apt-get update
sudo apt-get install -y libgtest-dev

# 检查库文件是否已自动编译
ls /usr/lib/x86_64-linux-gnu/libgtest.a

# 如果库文件存在，创建符号链接
if [ -f /usr/lib/x86_64-linux-gnu/libgtest.a ]; then
    sudo ln -sf /usr/lib/x86_64-linux-gnu/libgtest.a /usr/lib/libgtest.a
    sudo ln -sf /usr/lib/x86_64-linux-gnu/libgtest_main.a /usr/lib/libgtest_main.a
    echo "✅ GTest 已安装"
else
    # 需要手动编译
    cd /usr/src/gtest
    sudo rm -rf CMakeCache.txt CMakeFiles
    sudo cmake -DCMAKE_BUILD_TYPE=Release .
    sudo make -j$(nproc)
    sudo cp lib/*.a /usr/lib/
    echo "✅ GTest 编译完成"
fi
```

### 方法B: 使用安装脚本

```bash
cd ~/软工/code_cpp
chmod +x install_gtest_fixed.sh
./install_gtest_fixed.sh
```

---

## 步骤2: 验证 GTest 安装

```bash
# 检查头文件
ls /usr/include/gtest/gtest.h

# 检查库文件
ls /usr/lib/libgtest.a || ls /usr/lib/x86_64-linux-gnu/libgtest.a

# 如果都找到了，说明安装成功
```

---

## 步骤3: 运行单元测试

### 方法A: 使用 Makefile（推荐）

```bash
cd ~/软工/code_cpp

# 清理之前的编译
make clean

# 编译并运行 Storage 模块测试
make test-storage

# 编译并运行 Search 模块测试
make test-search

# 或者运行所有测试
make test-all
```

### 方法B: 手动编译运行

如果 Makefile 不工作，可以手动编译：

```bash
cd ~/软工/code_cpp

# 创建 bin 目录
mkdir -p bin

# 编译 Storage 测试
g++ -std=c++17 -O2 -I./src -I./tests -I/usr/include \
    -o bin/test_storage_gtest.exe \
    tests/test_storage_gtest.cpp \
    src/Category.cpp src/MainUI.cpp src/Record.cpp src/Search.cpp \
    src/Statistics.cpp src/Storage.cpp src/User.cpp src/main.cpp \
    -L/usr/lib/x86_64-linux-gnu -L/usr/lib -lgtest -lgtest_main -lpthread

# 运行 Storage 测试
./bin/test_storage_gtest.exe

# 编译 Search 测试
g++ -std=c++17 -O2 -I./src -I./tests -I/usr/include \
    -o bin/test_search_gtest.exe \
    tests/test_search_gtest.cpp \
    src/Category.cpp src/MainUI.cpp src/Record.cpp src/Search.cpp \
    src/Statistics.cpp src/Storage.cpp src/User.cpp src/main.cpp \
    -L/usr/lib/x86_64-linux-gnu -L/usr/lib -lgtest -lgtest_main -lpthread

# 运行 Search 测试
./bin/test_search_gtest.exe
```

---

## 步骤4: 查看测试结果

### 成功输出示例

```
[==========] Running 18 tests from 1 test suite.
[----------] Global test environment set-up.
[----------] 18 tests from StorageTest
[ RUN      ] StorageTest.ConstructorWithDefaultDir
[       OK ] StorageTest.ConstructorWithDefaultDir (1 ms)
[ RUN      ] StorageTest.ConstructorWithCustomDir
[       OK ] StorageTest.ConstructorWithCustomDir (0 ms)
...
[----------] 18 tests from StorageTest (15 ms total)

[----------] Global test environment tear-down
[==========] 18 tests from 1 test suite ran. (20 ms total)
[  PASSED  ] 18 tests.
```

### 如果看到这个输出，说明测试成功！

---

## 常见问题解决

### 问题1: 找不到 gtest.h

**错误信息**: `fatal error: gtest/gtest.h: No such file or directory`

**解决方法**:
```bash
# 安装 GTest
sudo apt-get install -y libgtest-dev

# 检查安装位置
find /usr -name "gtest.h"
```

### 问题2: 找不到 -lgtest

**错误信息**: `cannot find -lgtest`

**解决方法**:
```bash
# 检查库文件位置
find /usr -name "libgtest.a"

# 如果在 /usr/lib/x86_64-linux-gnu/，创建符号链接
sudo ln -sf /usr/lib/x86_64-linux-gnu/libgtest.a /usr/lib/libgtest.a
sudo ln -sf /usr/lib/x86_64-linux-gnu/libgtest_main.a /usr/lib/libgtest_main.a
```

### 问题3: CMake 版本错误

**错误信息**: `Compatibility with CMake < 3.5 has been removed`

**解决方法**:
```bash
cd /usr/src/gtest
sudo rm -rf CMakeCache.txt CMakeFiles
sudo cmake -DCMAKE_BUILD_TYPE=Release .
sudo make -j$(nproc)
sudo cp lib/*.a /usr/lib/
```

### 问题4: 编译成功但运行失败

**可能原因**: 库路径问题

**解决方法**:
```bash
# 设置库路径
export LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH

# 或者使用完整路径
g++ ... -L/usr/lib/x86_64-linux-gnu -lgtest ...
```

---

## 快速测试脚本

创建一个一键运行脚本：

```bash
cat > ~/软工/code_cpp/run_tests.sh << 'EOF'
#!/bin/bash
cd ~/软工/code_cpp

echo "=== 运行单元测试 ==="
echo ""

# 检查 GTest
if [ ! -f /usr/include/gtest/gtest.h ] && [ ! -f /usr/local/include/gtest/gtest.h ]; then
    echo "❌ GTest 未安装，正在安装..."
    sudo apt-get install -y libgtest-dev
    if [ -f /usr/lib/x86_64-linux-gnu/libgtest.a ]; then
        sudo ln -sf /usr/lib/x86_64-linux-gnu/libgtest.a /usr/lib/libgtest.a
        sudo ln -sf /usr/lib/x86_64-linux-gnu/libgtest_main.a /usr/lib/libgtest_main.a
    fi
fi

# 清理并编译
echo "清理旧文件..."
make clean

# 运行 Storage 测试
echo ""
echo "=== 运行 Storage 模块测试 ==="
make test-storage || {
    echo "Makefile 失败，尝试手动编译..."
    g++ -std=c++17 -O2 -I./src -I./tests -I/usr/include \
        -o bin/test_storage_gtest.exe \
        tests/test_storage_gtest.cpp src/*.cpp \
        -L/usr/lib/x86_64-linux-gnu -L/usr/lib -lgtest -lgtest_main -lpthread
    ./bin/test_storage_gtest.exe
}

# 运行 Search 测试
echo ""
echo "=== 运行 Search 模块测试 ==="
make test-search || {
    echo "Makefile 失败，尝试手动编译..."
    g++ -std=c++17 -O2 -I./src -I./tests -I/usr/include \
        -o bin/test_search_gtest.exe \
        tests/test_search_gtest.cpp src/*.cpp \
        -L/usr/lib/x86_64-linux-gnu -L/usr/lib -lgtest -lgtest_main -lpthread
    ./bin/test_search_gtest.exe
}

echo ""
echo "=== 测试完成 ==="
EOF

chmod +x ~/软工/code_cpp/run_tests.sh
```

然后运行：
```bash
cd ~/软工/code_cpp
./run_tests.sh
```

---

## 截图建议

运行测试时，建议截图以下内容：

1. **测试执行命令**: 显示 `make test-storage` 或 `make test-search`
2. **编译过程**: 显示编译输出（如果有）
3. **测试结果**: 显示所有测试通过的最终输出
4. **测试统计**: 显示 `[  PASSED  ] 18 tests.` 这样的统计信息

---

## 最简单的运行方式

如果你已经安装了 GTest，最简单的方式就是：

```bash
cd ~/软工/code_cpp
make clean
make test-storage
make test-search
```

如果遇到任何错误，请告诉我具体的错误信息，我会帮你解决！

