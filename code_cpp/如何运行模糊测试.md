# 如何运行模糊测试 - 完整指南

## 一、模糊测试概述

### 1.1 什么是模糊测试

模糊测试（Fuzzing）是一种自动化软件测试技术，通过向程序输入大量随机或半随机的数据来发现程序中的漏洞、崩溃和异常行为。

### 1.2 使用的工具

- **工具**: AFL++ (American Fuzzy Lop++)
- **特点**: 
  - 代码覆盖率引导的模糊测试
  - 能够发现缓冲区溢出、崩溃等安全问题
  - 适合C/C++项目

### 1.3 测试目标

- 发现程序中的崩溃（crash）
- 发现缓冲区溢出等安全问题
- 验证程序对异常输入的健壮性

---

## 二、安装 AFL++

### 方法1: 使用包管理器（推荐，Ubuntu/Debian）

```bash
sudo apt-get update
sudo apt-get install -y afl++
```

### 方法2: 从源码编译安装

```bash
# 安装依赖
sudo apt-get install -y build-essential clang llvm

# 克隆AFL++仓库
cd /tmp
git clone https://github.com/AFLplusplus/AFLplusplus.git
cd AFLplusplus

# 编译安装
make
sudo make install
```

### 验证安装

```bash
# 检查afl-fuzz是否可用
afl-fuzz --help

# 检查afl-g++是否可用
afl-g++ --help
```

---

## 三、准备模糊测试

### 3.1 检查目标程序

模糊测试目标程序位于：`code_cpp/fuzz_test_target.cpp`

该程序：
- 从标准输入读取TSV格式的记录数据
- 解析记录并测试Storage功能
- 测试`copyCategoryName`函数（包含缓冲区溢出缺陷）

### 3.2 使用设置脚本（推荐）

```bash
cd ~/软工/code_cpp

# 给脚本添加执行权限
chmod +x afl_fuzz_setup.sh

# 运行设置脚本
./afl_fuzz_setup.sh
```

### 3.3 手动设置

如果脚本不工作，可以手动设置：

```bash
cd ~/软工/code_cpp

# 1. 创建目录
mkdir -p fuzz_bin fuzz_input fuzz_output

# 2. 编译模糊测试目标程序（使用afl-g++）
afl-g++ -std=c++17 -O2 -I./src -o fuzz_bin/fuzz_target \
    fuzz_test_target.cpp \
    src/Category.cpp src/MainUI.cpp src/Record.cpp src/Search.cpp \
    src/Statistics.cpp src/Storage.cpp src/User.cpp

# 3. 创建测试输入
echo "r1	2025-01-01	100.0	I	工资	测试" > fuzz_input/test1.txt
echo "r2	2025-01-02	50.5	E	餐饮	午餐" > fuzz_input/test2.txt
echo "r3	2025-01-03	200.0	I	奖金	年终奖" > fuzz_input/test3.txt

# 4. 设置core pattern（需要root权限）
echo core | sudo tee /proc/sys/kernel/core_pattern
```

---

## 四、运行模糊测试

### 4.1 基本运行命令

```bash
cd ~/软工/code_cpp

# 运行模糊测试
afl-fuzz -i fuzz_input -o fuzz_output -- ./fuzz_bin/fuzz_target
```

### 4.2 运行参数说明

- `-i fuzz_input`: 指定输入目录（包含初始测试用例）
- `-o fuzz_output`: 指定输出目录（存放测试结果）
- `--`: 分隔AFL++参数和目标程序
- `./fuzz_bin/fuzz_target`: 要测试的目标程序

### 4.3 运行时间

根据实验要求：
- **至少运行5小时**（如果未发现崩溃）
- 如果发现崩溃，可以提前停止

### 4.4 后台运行（推荐）

由于模糊测试需要长时间运行，建议在后台运行：

```bash
# 使用nohup在后台运行
nohup afl-fuzz -i fuzz_input -o fuzz_output -- ./fuzz_bin/fuzz_target > fuzz.log 2>&1 &

# 查看运行状态
tail -f fuzz.log

# 或者使用screen/tmux
screen -S fuzzing
afl-fuzz -i fuzz_input -o fuzz_output -- ./fuzz_bin/fuzz_target
# 按 Ctrl+A 然后 D 来分离会话
# 重新连接: screen -r fuzzing
```

---

## 五、查看测试结果

### 5.1 实时查看

运行`afl-fuzz`时，会显示实时统计信息：

```
american fuzzy lop ++3.15a (default) [fast] {0}
┌─ process timing ──────────────────────────────────────┐
│        run time : 0 days, 0 hrs, 5 min, 23 sec       │
│   last new path : 0 days, 0 hrs, 0 min, 12 sec       │
│ last uniq crash : none seen yet                       │
│  last uniq hang : none seen yet                       │
└───────────────────────────────────────────────────────┘
┌─ cycle progress ─────────────────────────────────────┐
│  now processing : 1234 (45.6%)                        │
│ paths timed out : 0 (0.00%)                           │
└───────────────────────────────────────────────────────┘
┌─ map coverage ────────────────────────────────────────┐
│    map density : 2.15% / 3.07%                        │
│ count coverage : 4.15 bits/tuple                     │
└───────────────────────────────────────────────────────┘
┌─ stage progress ──────────────────────────────────────┐
│  now trying : havoc                                   │
│ stage execs : 12345/256                               │
│ total execs : 123456                                   │
│  exec speed : 1234/sec                                │
└───────────────────────────────────────────────────────┘
```

### 5.2 查看崩溃用例

如果发现崩溃，会在`fuzz_output/default/crashes/`目录下：

```bash
# 查看崩溃文件
ls -lh fuzz_output/default/crashes/

# 查看崩溃文件内容
cat fuzz_output/default/crashes/id:000000*

# 复现崩溃
./fuzz_bin/fuzz_target < fuzz_output/default/crashes/id:000000*
```

### 5.3 查看测试统计

```bash
# 查看测试统计信息
cat fuzz_output/default/fuzzer_stats

# 查看发现的路径
ls fuzz_output/default/queue/
```

---

## 六、复现崩溃

### 6.1 使用崩溃文件复现

```bash
# 使用崩溃文件作为输入
./fuzz_bin/fuzz_target < fuzz_output/default/crashes/id:000000*

# 如果程序崩溃，会看到段错误或异常信息
```

### 6.2 使用调试器分析

```bash
# 使用gdb调试崩溃
gdb ./fuzz_bin/fuzz_target
(gdb) run < fuzz_output/default/crashes/id:000000*

# 查看崩溃位置
(gdb) bt
(gdb) info registers
```

### 6.3 使用AddressSanitizer编译（推荐）

为了更详细地分析崩溃，可以使用ASan编译：

```bash
# 使用ASan重新编译
afl-clang++ -fsanitize=address -g -std=c++17 -I./src \
    -o fuzz_bin/fuzz_target_asan \
    fuzz_test_target.cpp src/*.cpp

# 使用ASan版本复现崩溃
./fuzz_bin/fuzz_target_asan < fuzz_output/default/crashes/id:000000*
```

---

## 七、常见问题

### 问题1: 找不到afl-fuzz命令

**解决方法**:
```bash
# 安装AFL++
sudo apt-get install afl++

# 或从源码编译安装
```

### 问题2: 无法设置core_pattern

**解决方法**:
```bash
# 需要root权限
echo core | sudo tee /proc/sys/kernel/core_pattern

# 或者使用
sudo sysctl -w kernel.core_pattern=core
```

### 问题3: 程序运行太慢

**解决方法**:
- 检查编译优化选项（使用-O2而不是-O3）
- 减少测试输入的大小
- 使用更快的模糊测试模式

### 问题4: 没有发现崩溃

**解决方法**:
- 确保运行时间足够长（至少5小时）
- 检查目标程序是否真的包含可触发的缺陷
- 尝试不同的初始测试用例

### 问题5: 在WSL中运行

**解决方法**:
```bash
# WSL中需要设置core_pattern
echo core | sudo tee /proc/sys/kernel/core_pattern

# 可能需要禁用ASLR（仅用于测试）
sudo sysctl -w kernel.randomize_va_space=0
```

---

## 八、截图建议

为了实验报告，建议截图以下内容：

1. **AFL++安装截图**
   - 显示`afl-fuzz --help`的输出
   - 或显示安装过程

2. **编译过程截图**
   - 显示使用`afl-g++`编译的过程
   - 显示编译成功的信息

3. **模糊测试运行截图**
   - 显示`afl-fuzz`的运行界面
   - 显示实时统计信息（运行时间、发现的路径数等）
   - 如果发现崩溃，显示崩溃信息

4. **崩溃用例截图**
   - 显示崩溃文件列表
   - 显示崩溃文件内容
   - 显示复现崩溃的过程

5. **运行时间证明**
   - 如果未发现崩溃，显示运行时间（至少5小时）
   - 显示`fuzzer_stats`文件内容

---

## 九、快速开始

### 步骤1: 安装AFL++

```bash
sudo apt-get install afl++
```

### 步骤2: 设置模糊测试

```bash
cd ~/软工/code_cpp
chmod +x afl_fuzz_setup.sh
./afl_fuzz_setup.sh
```

### 步骤3: 运行模糊测试

```bash
# 前台运行（可以看到实时输出）
afl-fuzz -i fuzz_input -o fuzz_output -- ./fuzz_bin/fuzz_target

# 或后台运行（推荐，可以运行很长时间）
nohup afl-fuzz -i fuzz_input -o fuzz_output -- ./fuzz_bin/fuzz_target > fuzz.log 2>&1 &
```

### 步骤4: 查看结果

```bash
# 查看崩溃（如果有）
ls fuzz_output/default/crashes/

# 查看统计信息
cat fuzz_output/default/fuzzer_stats
```

---

## 十、预期结果

### 如果发现崩溃

AFL++应该能够发现`Storage::copyCategoryName`中的缓冲区溢出问题，当输入超长的类别名称时。

### 如果未发现崩溃

如果运行5小时后仍未发现崩溃，这是正常的。需要：
- 截图显示运行时间（至少5小时）
- 截图显示`fuzzer_stats`文件
- 说明已运行足够长时间但未发现崩溃

---

## 十一、注意事项

1. **运行环境**: AFL++主要在Linux环境下运行，Windows可以使用WSL
2. **运行时间**: 根据实验要求，至少运行5小时
3. **资源消耗**: 模糊测试会消耗CPU和内存，确保系统有足够资源
4. **崩溃分析**: 如果发现崩溃，需要分析崩溃原因并记录

---

现在你可以开始运行模糊测试了！如果遇到任何问题，请告诉我。

