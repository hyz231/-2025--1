# 测试说明文档

## 一、单元测试

### 测试框架
- **工具**: Google Test (GTest)
- **测试模块**: Storage, Search

### 运行单元测试

#### Windows环境
```powershell
# 需要先安装GTest
# 方法1: 使用vcpkg
vcpkg install gtest

# 方法2: 从源码编译
# 下载 https://github.com/google/googletest
# 按照官方文档编译安装

# 编译测试
cd code_cpp
make test-storage
make test-search

# 运行测试
.\bin\test_storage_gtest.exe
.\bin\test_search_gtest.exe
```

#### Linux环境
```bash
# 安装GTest
sudo apt-get install libgtest-dev
cd /usr/src/gtest
sudo cmake .
sudo make
sudo cp lib/*.a /usr/lib

# 编译和运行测试
cd code_cpp
make test-storage
make test-search
```

### 测试覆盖率

#### Storage模块测试用例（共18个）
1. 构造函数测试（默认目录、自定义目录）
2. 保存和加载空记录
3. 保存和加载单个记录
4. 保存和加载多个记录
5. 保存和加载包含特殊字符的记录
6. 保存和加载零金额记录
7. 保存和加载负数金额记录
8. 保存和加载大金额记录
9. 从不存在的文件加载记录
10. 保存记录覆盖现有文件
11. 保存和加载空类别
12. 保存和加载自定义类别
13. 保存类别时忽略非自定义类别
14. 从不存在的文件加载类别
15. 确保数据目录创建
16. 确保数据目录处理已存在目录
17. 保存记录时字段为空
18. 保存记录时字符串很长

#### Search模块测试用例（共20个）
1. 构造函数初始化测试
2. 设置和获取关键词
3. 设置和获取类别
4. 设置和获取时间范围
5. 按关键词搜索匹配记录
6. 按关键词在备注中搜索
7. 按关键词在类别中搜索
8. 空关键词搜索
9. 无匹配结果搜索
10. 关键词大小写敏感测试
11. 关键词部分匹配
12. 按类别搜索匹配记录
13. 空类别搜索
14. 无匹配类别搜索
15. 类别精确匹配
16. 按时间范围搜索记录
17. 空时间范围搜索
18. 单日时间范围搜索
19. 跨月时间范围搜索
20. 边界测试（空记录、长字符串等）

**覆盖率说明**: 
- Storage模块: 语句覆盖率约85%，测试用例18个
- Search模块: 语句覆盖率约82%，测试用例20个
- 两个模块均满足80%覆盖率或10+测试用例的要求

---

## 二、集成测试

### 测试方法
采用**自底向上**的集成测试方法

### 集成测试组

#### 测试组1: Storage + Search 集成
- **测试用例数**: 4个
- **测试内容**:
  1. 保存加载记录并按关键词搜索
  2. 保存加载记录并按类别搜索
  3. 保存加载记录并按时间范围搜索
  4. 保存加载记录并组合多个搜索条件

#### 测试组2: Storage + Statistics 集成
- **测试用例数**: 4个
- **测试内容**:
  1. 保存加载记录并生成时间统计
  2. 保存加载记录并生成类别统计
  3. 保存加载记录并生成全期间统计
  4. 保存加载类别并在统计中使用

### 运行集成测试

```bash
cd code_cpp
make test-integration
./bin/test_integration.exe
```

---

## 三、模糊测试

### 工具
- **工具**: AFL++ (American Fuzzy Lop++)
- **目标**: 发现缓冲区溢出、崩溃等安全问题

### 安装AFL++

#### Ubuntu/Debian
```bash
sudo apt-get install afl++
```

#### 从源码安装
```bash
git clone https://github.com/AFLplusplus/AFLplusplus
cd AFLplusplus
make
sudo make install
```

### 设置模糊测试

```bash
cd code_cpp
chmod +x afl_fuzz_setup.sh
./afl_fuzz_setup.sh
```

### 运行模糊测试

```bash
# 设置环境（仅需一次）
echo core | sudo tee /proc/sys/kernel/core_pattern

# 运行模糊测试（建议运行至少5小时）
afl-fuzz -i fuzz_input -o fuzz_output -- ./fuzz_bin/fuzz_target

# 查看崩溃用例
ls fuzz_output/default/crashes/

# 复现崩溃
./fuzz_bin/fuzz_target < fuzz_output/default/crashes/id:000000*
```

### 预期结果
- 模糊测试应该能够发现`Storage::copyCategoryName`中的缓冲区溢出问题
- 如果运行5小时未发现崩溃，需要提供运行截图证明

---

## 四、持续集成 (CI)

### GitHub Actions配置

配置文件位置: `.github/workflows/ci.yml`

### 触发条件
- 推送到`main`或`master`分支
- 向`main`或`master`分支发起Pull Request

### CI流程
1. 检出代码库
2. 安装构建工具（build-essential, cmake）
3. 安装Google Test
4. 编译项目
5. 运行单元测试
6. 运行原始测试

### 查看CI结果
1. 前往GitHub仓库
2. 点击"Actions"标签页
3. 查看工作流运行状态

---

## 五、测试结果分析

### 单元测试结果
- **Storage模块**: 18个测试用例，全部通过
- **Search模块**: 20个测试用例，全部通过
- **总体覆盖率**: 约83%

### 集成测试结果
- **测试组1**: 4个测试用例，全部通过
- **测试组2**: 4个测试用例，全部通过

### 缺陷修复
- 修复了4个关键缺陷：
  1. 内存泄漏
  2. 缓冲区溢出
  3. 双重释放
  4. NULL指针解引用

---

## 六、注意事项

1. **Windows环境**: 需要手动安装GTest，建议使用vcpkg
2. **Linux环境**: 可以使用包管理器安装GTest
3. **模糊测试**: 需要在Linux环境下运行，Windows可以使用WSL
4. **CI配置**: 确保GitHub仓库已启用Actions功能

